<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2018-01-03
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20180103" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Metron &#x2013; Elasticsearch in Metron</title>
    <link rel="stylesheet" href="../../css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="../../css/site.css" />
    <link rel="stylesheet" href="../../css/print.css" media="print" />

      
    <script type="text/javascript" src="../../js/apache-maven-fluido-1.3.0.min.js"></script>

                          
        
<script type="text/javascript">$( document ).ready( function() { $( '.carousel' ).carousel( { interval: 3500 } ) } );</script>
          
            </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                    <a href="http://metron.apache.org/" id="bannerLeft">
                                                                                                <img src="../../images/metron-logo.png"  alt="Apache Metron" width="148px" height="48px"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                              <li class="">
                    <a href="http://www.apache.org" class="externalLink" title="Apache">
        Apache</a>
        </li>
      <li class="divider ">/</li>
            <li class="">
                    <a href="http://metron.apache.org/" class="externalLink" title="Metron">
        Metron</a>
        </li>
      <li class="divider ">/</li>
            <li class="">
                    <a href="../../index.html" title="Documentation">
        Documentation</a>
        </li>
      <li class="divider ">/</li>
        <li class="">Elasticsearch in Metron</li>
        
                
                    
                  <li id="publishDate" class="pull-right">Last Published: 2018-01-03</li> <li class="divider pull-right">|</li>
              <li id="projectVersion" class="pull-right">Version: 0.4.2</li>
            
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">User Documentation</li>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
      <li>
    
                          <a href="../../index.html" title="Metron">
          <i class="icon-chevron-down"></i>
        Metron</a>
                    <ul class="nav nav-list">
                      
      <li>
    
                          <a href="../../Upgrading.html" title="Upgrading">
          <i class="none"></i>
        Upgrading</a>
            </li>
                                                                                                                                                      
      <li>
    
                          <a href="../../metron-analytics/index.html" title="Analytics">
          <i class="icon-chevron-right"></i>
        Analytics</a>
                  </li>
                      
      <li>
    
                          <a href="../../metron-contrib/metron-docker/index.html" title="Docker">
          <i class="none"></i>
        Docker</a>
            </li>
                                                                                                                                                                                                                                                                                                                                                                                                            
      <li>
    
                          <a href="../../metron-deployment/index.html" title="Deployment">
          <i class="icon-chevron-right"></i>
        Deployment</a>
                  </li>
                      
      <li>
    
                          <a href="../../metron-interface/metron-alerts/index.html" title="Alerts">
          <i class="none"></i>
        Alerts</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-interface/metron-config/index.html" title="Config">
          <i class="none"></i>
        Config</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-interface/metron-rest/index.html" title="Rest">
          <i class="none"></i>
        Rest</a>
            </li>
                                                                                                                                                                                                                                                                                              
      <li>
    
                          <a href="../../metron-platform/index.html" title="Platform">
          <i class="icon-chevron-down"></i>
        Platform</a>
                    <ul class="nav nav-list">
                      
      <li>
    
                          <a href="../../metron-platform/Performance-tuning-guide.html" title="Performance-tuning-guide">
          <i class="none"></i>
        Performance-tuning-guide</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-api/index.html" title="Api">
          <i class="none"></i>
        Api</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-common/index.html" title="Common">
          <i class="none"></i>
        Common</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-data-management/index.html" title="Data-management">
          <i class="none"></i>
        Data-management</a>
            </li>
                      
      <li class="active">
    
            <a href="#"><i class="none"></i>Elasticsearch</a>
          </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-enrichment/index.html" title="Enrichment">
          <i class="none"></i>
        Enrichment</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-indexing/index.html" title="Indexing">
          <i class="none"></i>
        Indexing</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-management/index.html" title="Management">
          <i class="none"></i>
        Management</a>
            </li>
                                                                        
      <li>
    
                          <a href="../../metron-platform/metron-parsers/index.html" title="Parsers">
          <i class="icon-chevron-right"></i>
        Parsers</a>
                  </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-pcap-backend/index.html" title="Pcap-backend">
          <i class="none"></i>
        Pcap-backend</a>
            </li>
                      
      <li>
    
                          <a href="../../metron-platform/metron-writer/index.html" title="Writer">
          <i class="none"></i>
        Writer</a>
            </li>
              </ul>
        </li>
                                                                                          
      <li>
    
                          <a href="../../metron-sensors/index.html" title="Sensors">
          <i class="icon-chevron-right"></i>
        Sensors</a>
                  </li>
                      
      <li>
    
                          <a href="../../metron-stellar/stellar-3rd-party-example/index.html" title="Stellar-3rd-party-example">
          <i class="none"></i>
        Stellar-3rd-party-example</a>
            </li>
                                                                        
      <li>
    
                          <a href="../../metron-stellar/stellar-common/index.html" title="Stellar-common">
          <i class="icon-chevron-right"></i>
        Stellar-common</a>
                  </li>
                                                                                          
      <li>
    
                          <a href="../../use-cases/index.html" title="Use-cases">
          <i class="icon-chevron-right"></i>
        Use-cases</a>
                  </li>
              </ul>
        </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="../../images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>Elasticsearch in Metron</h1>
<p><a name="Elasticsearch_in_Metron"></a></p>
<div class="section">
<h2><a name="Introduction"></a>Introduction</h2>
<p>Elasticsearch can be used as the real-time portion of the datastore resulting from <a href="../metron-indexing/index.html">metron-indexing</a>.</p></div>
<div class="section">
<h2><a name="Properties"></a>Properties</h2>
<div class="section">
<h3><a name="es.clustername"></a><tt>es.clustername</tt></h3>
<p>The name of the elasticsearch Cluster. See <a class="externalLink" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/important-settings.html#cluster.name">here</a></p></div>
<div class="section">
<h3><a name="es.ip"></a><tt>es.ip</tt></h3>
<p>Specifies the nodes in the elasticsearch cluster to use for writing. The format is one of the following:</p>

<ul>
  
<li>A hostname or IP address with a port (e.g. <tt>hostname1:1234</tt>), in which case <tt>es.port</tt> is ignored.</li>
  
<li>A hostname or IP address without a port (e.g. <tt>hostname1</tt>), in which case <tt>es.port</tt> is used.</li>
  
<li>A string containing a CSV of hostnames without ports (e.g. <tt>hostname1,hostname2,hostname3</tt>) without spaces between. <tt>es.port</tt> is assumed to be the port for each host.</li>
  
<li>A string containing a CSV of hostnames with ports (e.g. <tt>hostname1:1234,hostname2:1234,hostname3:1234</tt>) without spaces between. <tt>es.port</tt> is ignored.</li>
  
<li>A list of hostnames with ports (e.g. <tt>[ &quot;hostname1:1234&quot;, &quot;hostname2:1234&quot;]</tt>). Note, <tt>es.port</tt> is NOT used in this construction.</li>
</ul></div>
<div class="section">
<h3><a name="es.port"></a><tt>es.port</tt></h3>
<p>The port for the elasticsearch hosts. This will be used in accordance with the discussion of <tt>es.ip</tt>.</p></div>
<div class="section">
<h3><a name="es.date.format"></a><tt>es.date.format</tt></h3>
<p>The date format to use when constructing the indices. For every message, the date format will be applied to the current time and that will become the last part of the index name where the message is written to.</p>
<p>For instance, an <tt>es.date.format</tt> of <tt>yyyy.MM.dd.HH</tt> would have the consequence that the indices would roll hourly, whereas an <tt>es.date.format</tt> of <tt>yyyy.MM.dd</tt> would have the consequence that the indices would roll daily.</p></div></div>
<div class="section">
<h2><a name="Using_Metron_with_Elasticsearch_2.x"></a>Using Metron with Elasticsearch 2.x</h2>
<p>With Elasticsearch 2.x, there is a requirement that all sensors templates have a nested alert field defined. This field is a dummy field, and will be obsolete in Elasticsearch 5.x. See <a class="externalLink" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-sort.html#_ignoring_unmapped_fields">Ignoring Unmapped Fields</a> for more information</p>
<p>Without this field, an error will be thrown during ALL searches (including from UIs, resulting in no alerts being found for any sensor). This error will be found in the REST service&#x2019;s logs.</p>
<p>Exception seen:</p>

<div class="source">
<div class="source">
<pre>QueryParsingException[[nested] failed to find nested object under path [alert]];
</pre></div></div>
<p>There are two steps to resolve this issue. First is to update the Elasticsearch template for each sensor, so any new indices have the field. This requires retrieving the template, removing an extraneous JSON field so we can put it back later, and adding our new field.</p>
<p>Make sure to set the ELASTICSEARCH variable appropriately. $SENSOR can contain wildcards, so if rollover has occurred, it&#x2019;s not necessary to do each index individually. The example here appends <tt>index*</tt> to get all indexes for a the provided sensor.</p>

<div class="source">
<div class="source">
<pre>export ELASTICSEARCH=&quot;node1&quot;
export SENSOR=&quot;bro&quot;
curl -XGET &quot;http://${ELASTICSEARCH}:9200/_template/${SENSOR}_index*?pretty=true&quot; -o &quot;${SENSOR}.template&quot;
sed -i '' '2d;$d' ./${SENSOR}.template
sed -i '' '/&quot;properties&quot; : {/ a\
&quot;alert&quot;: { &quot;type&quot;: &quot;nested&quot;},' ${SENSOR}.template
</pre></div></div>
<p>To manually verify this, you can optionally pretty print it again with:</p>

<div class="source">
<div class="source">
<pre>python -m json.tool bro.template
</pre></div></div>
<p>We&#x2019;ll want to put the template back into Elasticsearch:</p>

<div class="source">
<div class="source">
<pre>curl -XPUT &quot;http://${ELASTICSEARCH}:9200/_template/${SENSOR}_index&quot; -d @${SENSOR}.template
</pre></div></div>
<p>To update existing indexes, update Elasticsearch mappings with the new field for each sensor. </p>

<div class="source">
<div class="source">
<pre>curl -XPUT &quot;http://${ELASTICSEARCH}:9200/${SENSOR}_index*/_mapping/${SENSOR}_doc&quot; -d '
{
        &quot;properties&quot; : {
          &quot;alert&quot; : {
            &quot;type&quot; : &quot;nested&quot;
          }
        }
}
'
rm ${SENSOR}.template
</pre></div></div></div>
<div class="section">
<h2><a name="Installing_Elasticsearch_Templates"></a>Installing Elasticsearch Templates</h2>
<p>The stock set of Elasticsearch templates for bro, snort, yaf, error index and meta index are installed automatically during the first time install and startup of Metron Indexing service.</p>
<p>It is possible that Elasticsearch service is not available when the Metron Indexing Service startup, in that case the Elasticsearch template will not be installed. </p>
<p>For such a scenario, an Admin can have the template installed in two ways:</p>
<p><i>Method 1</i> - Manually from the Ambari UI by following the flow: Ambari UI -&gt; Services -&gt; Metron -&gt; Service Actions -&gt; Elasticsearch Template Install</p>
<p><i>Method 2</i> - Stop the Metron Indexing service, and start it again from Ambari UI. Note that the Metron Indexing service tracks if it has successfully installed the Elasticsearch templates, and will attempt to do so each time it is Started until successful.</p>

<blockquote>
<p>Note: If you have made any customization to your index templates, then installing Elasticsearch templates afresh will lead to overwriting your existing changes. Please exercise caution.</p>
</blockquote></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2018
                        <a href="https://www.apache.org">The Apache Software Foundation</a>.
            All Rights Reserved.      
                    
      </div>

                          
        
                </div>
    </footer>
  </body>
</html>
